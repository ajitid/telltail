<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telltail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- styles generated by dropping this html code into https://play.tailwindcss.com/ -->
    <!-- <link rel="stylesheet" href="/static/style.css" /> -->
    <link rel="preconnect" href="https://rsms.me/" />
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
    <style>
      :root {
        font-family: "Inter", sans-serif;
      }

      @supports (font-variation-settings: normal) {
        :root {
          font-family: "Inter var", sans-serif;
        }
      }
    </style>
  </head>

  <body class="bg-gray-100">
    <div class="container mx-auto px-3 py-6">
      <!-- <img src="/static/wifi.svg" alt="Logo"  /> -->
      <!-- remove wifi.svg from static/ if you're removing it from here too -->
      <h1 class="font-bold text-4xl mb-4">Telltail</h1>
      <input
        type="text"
        value="{{.Text}}"
        id="text"
        class="px-2 py-1 rounded-md border-2"
      />
      <button
        type="button"
        id="copy"
        class="px-2 py-1 bg-sky-700 text-white rounded-md shadow"
      >
        Copy
      </button>
      <button
        type="button"
        id="open-link"
        class="px-2 py-1 bg-sky-700 text-white rounded-md shadow"
      >
        Open link â†—
      </button>
    </div>
    <script type="text/javascript">
      function debounce(func, timeout = 300) {
        let timer;
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => {
            func.apply(this, args);
          }, timeout);
        };
      }

      const textEl = document.querySelector("#text");
      const openLinkEl = document.querySelector("#open-link");

      // TODO open links in a no refererr new tab kinda way (see macwright.com's post on hackernews redirect)
      // - stuff without noreferrer noopener nofollow can be sent to their analytics website which most people would like not to do
      // check hwo browsers handle opening multiple links simultaneously
      // if it fails:
      // split('\n') and only open the first link
      // check if ananto's linkify can be used to recognize and list links
      openLinkEl.addEventListener("click", () => {
        window.open(textEl.value, "_blank");
      });

      function checkAndShowOpenLinkButton(text) {
        try {
          new URL(textEl.value);
          openLinkEl.classList.remove("hidden");
        } catch {
          openLinkEl.classList.add("hidden");
        }
      }
      checkAndShowOpenLinkButton();

      textEl.addEventListener(
        "input",
        debounce((ev) => {
          const text = ev.target.value;
          fetch("/set", {
            method: "POST",
            headers: {
              "Content-Type": "text/plain; charset=UTF-8",
            },
            body: text,
          });

          // multiline should be supported but there shouldn't any fancy-schmancy open link
          // just identify if first line is a link and open it
          checkAndShowOpenLinkButton();
        })
      );

      document.querySelector("#copy").addEventListener("click", () => {
        navigator.clipboard.writeText(textEl.value);
      });
    </script>
  </body>
</html>
